pkg:
  Controller: biz/controller/admin
  Bind: biz/controller/internal
  Service: biz/service
  Req:  biz/request
  Resp: sections/response
  Model: sections/models
  RespName: response
  Biz:  biz
  IdlName: admin


global:
  - name: router
    path: "{{.Pkg.Biz}}/router.go"
    write: pointer
    handler-key: "New{{snakeToUpperCamelCase .ServiceName}}Router"
    handler: "\tNew{{snakeToUpperCamelCase .ServiceName}}Router(admin)"
    body: |-
      // Code generated by go-server-gen. DO NOT EDIT.
      
      package {{.Pkg.Biz}}
      import (
          "{{.Pkg.EngineImport}}"
          swaggerFiles "github.com/swaggo/files"
          ginSwagger "github.com/swaggo/gin-swagger"
          _ "{{.ProjectName}}/docs"
      )
      func Register(e *gin.RouterGroup) {
          e.GET("/api/admin/swagger/*any", ginSwagger.WrapHandler(swaggerFiles.Handler))
          //INSERT_POINT: DO NOT DELETE THIS LINE!
          {{- range $_, $Code := .Handlers }}
          {{$Code}}
          {{- end }}
      }

  - name: router
    path: "{{.Pkg.Biz}}/admin.router.go"
    write: append
    body: |-
      package {{.Pkg.Biz}}
      import (
          "{{.Pkg.EngineImport}}"
          "{{.ProjectName}}/{{.Pkg.Controller}}"
      )
      {{- range $_, $Code := .Handlers }}
      {{$Code}}
      {{- end }}
    handler-key: "New{{snakeToUpperCamelCase .ServiceName}}Router"
    handler: |
      func New{{snakeToUpperCamelCase .ServiceName}}Router(e *gin.RouterGroup) {
          {{.ServiceName | lowercaseFirst}} := e.Group("")
          {
              {{- range $_, $Api := .Apis}}
              {{$Api.ServiceName | lowercaseFirst}}.{{getGoMethod $Api.Method $Api.Pkg.ContextType}}("{{$Api.Path}}", {{getGoLastSplit $.Pkg.Controller "/"}}.{{$Api.Handler}})
              {{- end}}
          }
      }

  - name: request
    path: "{{.Pkg.Req}}/admin.go"
    write: append
    body: |-
      package {{getGoLastSplit $.Pkg.Req "/"}}
      
      import (
        "{{.ProjectName}}/{{.Pkg.Model}}"
      )
      {{- range $_, $Code := .Handlers }}
      {{$Code}}
      {{ end }}
    handler-key: "{{snakeToUpperCamelCase .ServiceName}}"
    handler: |-
      {{- range $_, $Msg := .MsgMap }}
      {{ if eq $Msg.Lang "go" -}}
      {{$Msg.Source}}
      {{- end}}
      {{ end }}


service:
  - name: controller
    path: "{{.Pkg.Controller}}/{{convertToWord .ServiceName `_`}}.go"
    write: append
    handler-key: "{{.FuncName}}"
    handler: |-
      // {{.FuncName}}
      // @Tags	{{convertToWord .ServiceName "-"}}
      // @Summary	{{.Summary}}
      {{- range $_, $Para := .ReqParam}}
      // @Param	{{$Para.Name}}	{{$Para.From}}	{{$Para.Type}}	{{$Para.Required}}	"{{$Para.Description}}"
      {{- end }}
      // @Success	200
      // @Router	{{getDocRouter .Path}} [{{.Method}}]
      func {{.FuncName}}(c {{.Pkg.ContextType}}) {
          var req {{getGoLastSplit .Pkg.Req "/"}}.{{.ReqName}}
          {{ if hasSuffix .FuncName "List" -}}
          if err := {{getGoLastSplit .Pkg.Bind "/"}}.BindQuery(c, &req).BindUser(&req.Operator).Error; err != nil {
            return
          }
      
          var total int64
          var data []models.{{removeSuffix (snakeToUpperCamelCase .ServiceName) "s"}}
          if err := orm.DB().Count(&total).Error; err != nil {
            {{.Pkg.RespName}}.ErrorSelect(c, err, "get {{.ServiceName}} total err")
            return
          }
          if err := orm.DB().Scopes(orm.Page(req.PageNumber, req.PageSize)).Find(&data).Error; err != nil {
            {{.Pkg.RespName}}.ErrorSelect(c, err, "get {{.ServiceName}} err")
            return
          }
          {{.Pkg.RespName}}.SuccessWithArrayData(c, data, total)
          {{ else if hasPrefix .FuncName "Get" -}}
          if err := {{getGoLastSplit .Pkg.Bind "/"}}.BindUri(c, &req).BindUser(&req.Operator).Error; err != nil {
            return
          }
          var data models.{{removeSuffix (snakeToUpperCamelCase .ServiceName) "s"}}
          if err := orm.DB().Where("id = ?", req.{{removeSuffix (snakeToUpperCamelCase .ServiceName) "s"}}ID).First(&data).Error; err != nil {
            {{.Pkg.RespName}}.ErrorSelect(c, err, "get {{.ServiceName}} err")
            return
          }
          {{.Pkg.RespName}}.SuccessWithData(c, data)
          {{ else if hasPrefix .FuncName "Delete" -}}
          if err := {{getGoLastSplit .Pkg.Bind "/"}}.BindUri(c, &req).BindUser(&req.Operator).Error; err != nil {
            return
          }
          if err := orm.DB().Where("id = ?", req.{{removeSuffix (snakeToUpperCamelCase .ServiceName) "s"}}ID).Delete(&models.{{removeSuffix (snakeToUpperCamelCase .ServiceName) "s"}}{}).Error; err != nil {
            {{.Pkg.RespName}}.ErrorDelete(c, err, "failed to delete {{.ServiceName}}")
            return
          }
          {{.Pkg.RespName}}.Success(c)
          {{ else if hasPrefix .FuncName "BatchDelete" -}}
          if err := {{getGoLastSplit .Pkg.Bind "/"}}.BindJson(c, &req).BindUser(&req.Operator).Error; err != nil {
            return
          }
          if err := orm.DB().Where("id IN ?", req.{{removeSuffix (snakeToUpperCamelCase .ServiceName) "s"}}IDs).Delete(&models.{{removeSuffix (snakeToUpperCamelCase .ServiceName) "s"}}{}).Error; err != nil {
            {{.Pkg.RespName}}.ErrorDelete(c, err, "failed to delete {{.ServiceName}}")
            return
          }
          {{.Pkg.RespName}}.Success(c)
          {{ else if hasPrefix .FuncName "Create" -}}
          if err := {{getGoLastSplit .Pkg.Bind "/"}}.BindUriAndJson(c, &req).BindUser(&req.Operator).Error; err != nil {
            return
          }
          data := models.{{removeSuffix (snakeToUpperCamelCase .ServiceName) "s"}}{
            UpdatedBy: req.Operator.ID,
            {{- range $_, $Column := .BodyColumns }}
            {{snakeToUpperCamelCase $Column.Column}}: req.{{snakeToUpperCamelCase $Column.Column}},
            {{- end }}
          }
          if err := orm.DB().Create(&data).Error; err != nil {
            {{.Pkg.RespName}}.ErrorCreate(c, err, "failed to create {{.ServiceName}}")
            return
          }
          {{.Pkg.RespName}}.Success(c)
          {{ else if hasPrefix .FuncName "Update" -}}
          if err := {{getGoLastSplit .Pkg.Bind "/"}}.BindUriAndJson(c, &req).BindUser(&req.Operator).Error; err != nil {
            return
          }
      
          data := models.{{removeSuffix (snakeToUpperCamelCase .ServiceName) "s"}}{
            UpdatedBy: req.Operator.ID,
            {{- range $_, $Column := .BodyColumns }}
            {{snakeToUpperCamelCase $Column.Column}}: req.{{snakeToUpperCamelCase $Column.Column}},
            {{- end }}
          }
          if err := orm.DB().Where("id = ?", req.{{removeSuffix (snakeToUpperCamelCase .ServiceName) "s"}}ID).Save(&data).Error; err != nil {
            {{.Pkg.RespName}}.ErrorCreate(c, err, "failed to create {{.ServiceName}}")
            return
          }
          {{.Pkg.RespName}}.Success(c)
          {{ else -}}
          if err := {{getGoLastSplit .Pkg.Bind "/"}}.BindUriAndJson(c, &req).BindUser(&req.Operator).Error; err != nil {
            return
          }
          {{ end -}}
      }
    body: |-
      package admin
      import (
          "{{.Pkg.ContextImport}}"
          "{{.ProjectName}}/{{.Pkg.Req}}"
          "{{.ProjectName}}/{{.Pkg.Resp}}"
          "{{.ProjectName}}/{{.Pkg.Bind}}"
          "{{.ProjectName}}/pkg/orm"
          "{{.ProjectName}}/{{.Pkg.Model}}"
      )
      {{- range $_, $Code := .Handlers }}
      {{$Code}}
      {{- end }}

  - name: client
    path: "web/src/api/{{convertToWord .ServiceName `-`}}.ts"
    write: append
    handler-key: "{{.FuncName}}"
    handler: |-
      {{ if hasSuffix .FuncName "List" -}}
      export async function {{lowercaseFirst .FuncName}}({{ mapJoin (getPathPara .Path) ": " ", " false }}): Promise<Root<{{snakeToUpperCamelCase .ServiceName}}>> {
        return await {{.Method}}<{{snakeToUpperCamelCase .ServiceName}}>(`{{.Path | getTsRouter}}`);
      }
      {{ else if hasPrefix .FuncName "Get" -}}
      export async function {{lowercaseFirst .FuncName}}({{ mapJoin (getPathPara .Path) ": " ", " false }}): Promise<Root<{{snakeToUpperCamelCase .ServiceName}}[]>> {
        return await {{.Method}}<{{snakeToUpperCamelCase .ServiceName}}[]>(`{{.Path | getTsRouter}}`);
      }
      {{ else if hasPrefix .FuncName "Update" -}}
      export async function {{lowercaseFirst .FuncName}}({{ mapJoin (getPathPara .Path) ": " ", " true }}data: object): Promise<Root<object>> {
        return await {{.Method}}(`{{.Path | getTsRouter}}`, data);
      }
      {{ else if hasPrefix .FuncName "Create" -}}
      export async function {{lowercaseFirst .FuncName}}({{ mapJoin (getPathPara .Path) ": " ", " true }}data: object): Promise<Root<{{snakeToUpperCamelCase .ServiceName}}>> {
        return await POST<{{snakeToUpperCamelCase .ServiceName}}>(`{{.Path | getTsRouter}}`, data);
      }
      {{ else if hasPrefix .FuncName "BatchDelete" -}}
      export async function {{lowercaseFirst .FuncName}}({{ mapJoin (getPathPara .Path) ": " ", " true }}data: object): Promise<Root<object>> {
        return await {{.Method}}(`{{.Path | getTsRouter}}`, data);
      }
      {{ else if hasPrefix .FuncName "Delete" -}}
      export async function {{lowercaseFirst .FuncName}}({{ mapJoin (getPathPara .Path) ": " ", " false }}): Promise<Root<object>> {
        return await {{.Method}}(`{{.Path | getTsRouter}}`);
      }
      {{ else -}}
      {{ end }}
    body: |-
      import {type Root, GET, POST, PUT, DELETE} from "./common"
      
      {{ range $Key, $Msg := .MsgMap }}
      {{- if eq $Key "__tsInterface" -}}
      {{$Msg.Source}}
      {{- end}}
      {{- end }}
      {{ range $_, $Code := .Handlers }}
      {{$Code}}
      {{- end }}

